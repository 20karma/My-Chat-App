<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ghost Network</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CORE THEME --- */
        :root {
            --bg: #000000;
            --panel: #111;
            --accent: #00E676; /* Hacker Green */
            --danger: #ff4444;
            --text: #ffffff;
            --border: 1px solid #222;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- AUTH SCREEN (LOGIN / REGISTER) --- */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 20px;
        }
        .auth-box { width: 100%; max-width: 350px; text-align: center; }
        
        .input-field {
            background: #111; border: 1px solid #333; color: white;
            padding: 15px; width: 100%; margin-bottom: 12px;
            border-radius: 8px; font-size: 16px; outline: none; transition: 0.3s;
        }
        .input-field:focus { border-color: var(--accent); }

        .btn-main {
            background: linear-gradient(45deg, #00E676, #00C853);
            color: black; font-weight: bold; border: none;
            padding: 15px; width: 100%; border-radius: 8px;
            font-size: 16px; cursor: pointer; margin-top: 10px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-link {
            background: none; border: none; color: var(--accent);
            margin-top: 15px; cursor: pointer; text-decoration: underline;
        }

        /* --- MAIN APP UI --- */
        #app-container { display: none; height: 100%; flex-direction: column; }
        
        header {
            padding: 10px 15px; background: rgba(10,10,10,0.95);
            border-bottom: var(--border); display: flex; justify-content: space-between; align-items: center; height: 60px;
        }
        .mini-dp {
            width: 35px; height: 35px; border-radius: 50%;
            background: #333; margin-right: 10px; border: 1px solid var(--accent);
            background-size: cover; background-position: center;
        }
        
        /* CONTENT & TABS */
        #content-area { flex: 1; overflow-y: auto; padding-bottom: 70px; }
        .screen { display: none; padding: 10px; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: #050505; border-top: var(--border);
            display: flex; justify-content: space-around; align-items: center; z-index: 1000;
        }
        .nav-item { font-size: 24px; color: #555; padding: 10px; transition: 0.2s; }
        .nav-item.active { color: var(--accent); transform: scale(1.1); }

        /* CHAT BUBBLES */
        .msg-bubble {
            max-width: 75%; padding: 10px 15px; border-radius: 15px;
            font-size: 14px; margin-bottom: 10px; position: relative; word-wrap: break-word;
        }
        .sent { align-self: flex-end; background: #005c4b; color: white; margin-left: auto; border-bottom-right-radius: 0; }
        .received { align-self: flex-start; background: #202c33; color: white; margin-right: auto; border-bottom-left-radius: 0; }
        .cipher { color: var(--accent); font-family: monospace; letter-spacing: 1px; font-size: 12px; }

        /* HIDDEN DECRYPT MODAL */
        #pin-modal {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            justify-content: center; align-items: center; flex-direction: column;
        }

        /* INPUT BAR */
        #chat-input-area {
            position: fixed; bottom: 60px; left: 0; width: 100%;
            background: #111; padding: 10px; display: flex; align-items: center;
            border-top: var(--border); z-index: 999;
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="color:var(--accent); letter-spacing:2px; margin-bottom:20px;">GHOST NET</h1>
        
        <div id="login-form" class="auth-box" style="display:none;">
            <div id="login-dp" class="mini-dp" style="width:80px; height:80px; margin:0 auto 20px;"></div>
            <h3 id="login-name">Welcome Back</h3>
            <input type="password" id="login-pin" class="input-field" placeholder="Enter PIN to Unlock" maxlength="4" style="text-align:center; letter-spacing:5px;">
            <button class="btn-main" onclick="attemptLogin()">LOGIN</button>
            <button class="btn-link" onclick="switchAuth('register')">Create New ID</button>
        </div>

        <div id="register-form" class="auth-box">
            <div style="width:80px; height:80px; background:#111; border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; border:2px dashed var(--accent); cursor:pointer;" onclick="document.getElementById('dp-upload').click()">
                <i class="fas fa-camera" style="font-size:24px; color:#555;"></i>
            </div>
            <input type="file" id="dp-upload" hidden accept="image/*" onchange="previewDP()">
            
            <input id="reg-name" class="input-field" placeholder="Full Name (Required)">
            <input id="reg-addr" class="input-field" placeholder="Address">
            <input id="reg-phone" class="input-field" placeholder="Phone (Optional)" type="number">
            <input id="reg-pin" class="input-field" placeholder="Set 4-Digit PIN" type="password" maxlength="4">
            
            <button class="btn-main" onclick="registerUser()">REGISTER</button>
            <button class="btn-link" onclick="switchAuth('login')">Already have an Account?</button>
        </div>
    </div>

    <div id="pin-modal">
        <h3 style="color:var(--accent)">DECRYPT CHATS</h3>
        <input id="decrypt-pin" class="input-field" style="width:150px; text-align:center;" type="password" placeholder="PIN" maxlength="4">
        <button class="btn-main" style="width:150px;" onclick="verifyDecryptPin()">UNLOCK</button>
        <button onclick="document.getElementById('pin-modal').style.display='none'" style="background:none; border:none; color:#777; margin-top:15px;">Cancel</button>
    </div>

    <div id="app-container">
        <header>
            <div style="display:flex; align-items:center;" onclick="triggerSecretUnlock()">
                <div class="mini-dp" id="nav-dp"></div>
                <span id="nav-name" style="font-weight:bold;">User</span>
            </div>
            <i class="fas fa-ellipsis-v" style="color:#777;"></i>
        </header>

        <div id="content-area">
            <div id="chat-screen" class="screen active">
                <div id="messages-list" style="padding-top:10px;"></div>
            </div>

            <div id="social-screen" class="screen">
                <h4 style="color:#555;">PEOPLE NEARBY</h4>
                <div style="background:#111; padding:10px; border-radius:8px; display:flex; align-items:center; margin-bottom:10px;">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" style="width:40px; height:40px; border-radius:50%; margin-right:10px;">
                    <div style="flex:1;"><b>Agent X</b><div style="font-size:10px; color:#777;">Online</div></div>
                    <button style="background:var(--accent); border:none; padding:5px 15px; border-radius:20px;">Follow</button>
                </div>
            </div>

            <div id="profile-screen" class="screen">
                <div style="text-align:center; padding:20px;">
                    <div class="mini-dp" id="profile-dp" style="width:100px; height:100px; margin:0 auto 15px;"></div>
                    <h2 id="profile-name">Name</h2>
                    <p id="profile-addr" style="color:#777;">Location</p>
                    <button onclick="logout()" style="background:#ff4444; color:white; border:none; padding:10px 30px; border-radius:5px; margin-top:20px;">LOGOUT</button>
                </div>
            </div>
        </div>

        <div id="chat-input-area">
            <i class="fas fa-paperclip" style="font-size:20px; color:#777; margin-right:15px;" onclick="document.getElementById('chat-img').click()"></i>
            <input type="file" id="chat-img" hidden accept="image/*" onchange="sendImage()">
            <input id="msg-input" class="input-field" style="margin:0; padding:10px; border-radius:20px;" placeholder="Message..." autocomplete="off">
            <i class="fas fa-paper-plane" style="font-size:20px; color:var(--accent); margin-left:15px;" onclick="sendMessage()"></i>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="nav('chat')"><i class="fas fa-comment-alt"></i></div>
            <div class="nav-item" onclick="nav('social')"><i class="fas fa-globe"></i></div>
            <div class="nav-item" onclick="nav('profile')"><i class="fas fa-user"></i></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentUser = null;
        let isDecrypted = false;
        let dblClickTimer;

        // --- 1. AUTH SYSTEM (LOGIN / REGISTER) ---
        window.onload = function() {
            const savedUser = localStorage.getItem('ghostUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                switchAuth('login');
                document.getElementById('login-name').innerText = currentUser.name;
                if(currentUser.dp) document.getElementById('login-dp').style.backgroundImage = `url(${currentUser.dp})`;
            } else {
                switchAuth('register');
            }
        };

        function switchAuth(mode) {
            document.getElementById('login-form').style.display = (mode === 'login') ? 'block' : 'none';
            document.getElementById('register-form').style.display = (mode === 'register') ? 'block' : 'none';
        }

        let tempDP = "";
        function previewDP() {
            const file = document.getElementById('dp-upload').files[0];
            const reader = new FileReader();
            reader.onload = e => tempDP = e.target.result;
            if(file) reader.readAsDataURL(file);
        }

        function registerUser() {
            const name = document.getElementById('reg-name').value;
            const addr = document.getElementById('reg-addr').value;
            const pin = document.getElementById('reg-pin').value;
            
            if(!name || !pin) return alert("Name & PIN are required!");

            const userData = { name, addr, pin, dp: tempDP };
            localStorage.setItem('ghostUser', JSON.stringify(userData)); // Save to Phone Memory
            
            currentUser = userData;
            enterApp();
        }

        function attemptLogin() {
            const enteredPin = document.getElementById('login-pin').value;
            if (enteredPin === currentUser.pin) {
                enterApp();
            } else {
                alert("WRONG PIN âŒ");
            }
        }

        function enterApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            
            // Set UI Data
            document.getElementById('nav-name').innerText = currentUser.name;
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-addr').innerText = currentUser.addr || "Unknown";
            
            if(currentUser.dp) {
                document.getElementById('nav-dp').style.backgroundImage = `url(${currentUser.dp})`;
                document.getElementById('profile-dp').style.backgroundImage = `url(${currentUser.dp})`;
            }

            socket.emit('new-user', currentUser.name);
        }

        function logout() {
            if(confirm("Logout & Clear Data?")) {
                localStorage.removeItem('ghostUser'); // Clear Memory
                location.reload();
            }
        }

        // --- 2. CHAT & DECRYPTION ---
        function triggerSecretUnlock() {
            // Header par 2 baar click karne par PIN maange
            if (dblClickTimer) {
                document.getElementById('pin-modal').style.display = 'flex';
                clearTimeout(dblClickTimer);
                dblClickTimer = null;
            } else {
                dblClickTimer = setTimeout(() => { dblClickTimer = null; }, 400);
            }
        }

        function verifyDecryptPin() {
            if(document.getElementById('decrypt-pin').value === currentUser.pin) {
                isDecrypted = true;
                document.getElementById('pin-modal').style.display = 'none';
                renderMessages();
                alert("CHATS DECRYPTED âœ…");
            } else {
                alert("INVALID PIN âŒ");
            }
        }

        // --- 3. MESSAGING LOGIC ---
        function sendMessage() {
            const txt = document.getElementById('msg-input').value;
            if(txt) {
                socket.emit('chat message', { user: currentUser.name, text: txt, type: 'text' });
                document.getElementById('msg-input').value = '';
            }
        }

        function sendImage() {
            const file = document.getElementById('chat-img').files[0];
            const reader = new FileReader();
            reader.onload = e => socket.emit('chat message', { user: currentUser.name, text: e.target.result, type: 'image' });
            if(file) reader.readAsDataURL(file);
        }

        let chatHistory = [];
        socket.on('chat message', (msg) => {
            chatHistory.push(msg);
            renderMessages();
        });

        function renderMessages() {
            const list = document.getElementById('messages-list');
            list.innerHTML = '';

            chatHistory.forEach(msg => {
                const isMe = msg.user === currentUser.name;
                const div = document.createElement('div');
                div.className = `msg-bubble ${isMe ? 'sent' : 'received'}`;
                
                let content = "";
                if (isDecrypted || isMe) { // Apna message humesha saaf dikhega
                    if(msg.type === 'image') content = `<img src="${msg.text}" style="max-width:100%; border-radius:10px;">`;
                    else content = msg.text;
                } else {
                    const garbage = "X7#9" + Math.floor(Math.random()*1000);
                    content = `<span class="cipher">ðŸ”’ ${garbage}</span>`;
                }

                div.innerHTML = `<div style="font-size:10px; opacity:0.7; margin-bottom:5px;">${msg.user}</div>${content}`;
                list.appendChild(div);
            });
            list.parentElement.scrollTop = list.parentElement.scrollHeight;
        }

        // --- 4. NAVIGATION ---
        function nav(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(screen+'-screen').classList.add('active');
            
            // Highlight Icon
            const icons = document.querySelectorAll('.nav-item');
            if(screen === 'chat') { icons[0].classList.add('active'); document.getElementById('chat-input-area').style.display='flex'; }
            if(screen === 'social') { icons[1].classList.add('active'); document.getElementById('chat-input-area').style.display='none'; }
            if(screen === 'profile') { icons[2].classList.add('active'); document.getElementById('chat-input-area').style.display='none'; }
        }
    </script>
</body>
</html>